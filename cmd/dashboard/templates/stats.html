{{template "base" .}}

{{define "content"}}
<h1>Statistiques</h1>

<div class="grid grid-3 mb-3">
    <!-- Quotation Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìã Quotation</span>
        </div>
        <div id="quotation-stats" hx-get="http://localhost:8081/api/v1/quotation/stats" hx-trigger="load, every 5s" hx-swap="innerHTML">
            <div class="text-center">Chargement...</div>
        </div>
    </div>

    <!-- Souscription Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìù Souscription</span>
        </div>
        <div id="souscription-stats" hx-get="http://localhost:8082/api/v1/souscription/stats" hx-trigger="load, every 5s" hx-swap="innerHTML">
            <div class="text-center">Chargement...</div>
        </div>
    </div>

    <!-- R√©clamation Stats -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">‚ö†Ô∏è R√©clamation</span>
        </div>
        <div id="reclamation-stats" hx-get="http://localhost:8083/api/v1/reclamation/stats" hx-trigger="load, every 5s" hx-swap="innerHTML">
            <div class="text-center">Chargement...</div>
        </div>
    </div>
</div>

<!-- Graphiques iframe Grafana -->
<div class="card">
    <div class="card-header">
        <span class="card-title">üìà M√©triques Grafana</span>
        <a href="http://localhost:3000" target="_blank" class="btn btn-primary">Ouvrir Grafana</a>
    </div>
    <div style="text-align: center; padding: 2rem; color: var(--text-light);">
        <p>Les graphiques d√©taill√©s sont disponibles dans Grafana.</p>
        <p>Dashboards disponibles:</p>
        <ul style="list-style: none; margin-top: 1rem;">
            <li>‚Ä¢ Kafka Overview</li>
            <li>‚Ä¢ Services Performance</li>
            <li>‚Ä¢ Business Metrics</li>
        </ul>
    </div>
</div>

<script>
    // Custom handler pour les stats
    document.body.addEventListener('htmx:afterSwap', function(event) {
        const target = event.detail.target;
        if (target.id.includes('-stats')) {
            try {
                const data = JSON.parse(event.detail.xhr.responseText);
                if (data.success && data.data) {
                    renderStats(target, data.data, target.id.replace('-stats', ''));
                }
            } catch (e) {
                target.innerHTML = '<div class="text-center">Donn√©es non disponibles</div>';
            }
        }
    });

    function renderStats(container, stats, type) {
        let html = '<div class="grid grid-2">';

        if (type === 'quotation') {
            html += `
                <div class="stat">
                    <div class="stat-value">${stats.total || 0}</div>
                    <div class="stat-label">Total devis</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.generes || 0}</div>
                    <div class="stat-label">G√©n√©r√©s</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.convertis || 0}</div>
                    <div class="stat-label">Convertis</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.expires || 0}</div>
                    <div class="stat-label">Expir√©s</div>
                </div>
            `;
        } else if (type === 'souscription') {
            html += `
                <div class="stat">
                    <div class="stat-value">${stats.total || 0}</div>
                    <div class="stat-label">Total contrats</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.actifs || 0}</div>
                    <div class="stat-label">Actifs</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.modifies || 0}</div>
                    <div class="stat-label">Modifi√©s</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.resilies || 0}</div>
                    <div class="stat-label">R√©sili√©s</div>
                </div>
            `;
        } else if (type === 'reclamation') {
            html += `
                <div class="stat">
                    <div class="stat-value">${stats.total || 0}</div>
                    <div class="stat-label">Total sinistres</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.declares || 0}</div>
                    <div class="stat-label">D√©clar√©s</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${stats.evalues || 0}</div>
                    <div class="stat-label">√âvalu√©s</div>
                </div>
                <div class="stat">
                    <div class="stat-value">${formatMoney(stats.totalIndemnise || 0)}</div>
                    <div class="stat-label">Indemnis√©</div>
                </div>
            `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    function formatMoney(amount) {
        if (amount >= 1000000) {
            return (amount / 1000000).toFixed(1) + 'M‚Ç¨';
        } else if (amount >= 1000) {
            return (amount / 1000).toFixed(1) + 'k‚Ç¨';
        }
        return amount.toFixed(0) + '‚Ç¨';
    }
</script>
{{end}}
