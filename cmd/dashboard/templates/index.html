{{template "base" .}}

{{define "content"}}
<h1>Dashboard</h1>

<!-- Services Status -->
<div class="card mb-3">
    <div class="card-header">
        <span class="card-title">Services</span>
        <span class="badge badge-success">Tous opÃ©rationnels</span>
    </div>
    <div class="service-list">
        <div class="service-item">
            <div class="service-info">
                <span class="service-status online"></span>
                <span>Quotation</span>
            </div>
            <a href="http://localhost:8081/api/v1/quotation/health" target="_blank" class="btn btn-secondary">:8081</a>
        </div>
        <div class="service-item">
            <div class="service-info">
                <span class="service-status online"></span>
                <span>Souscription</span>
            </div>
            <a href="http://localhost:8082/api/v1/souscription/health" target="_blank" class="btn btn-secondary">:8082</a>
        </div>
        <div class="service-item">
            <div class="service-info">
                <span class="service-status online"></span>
                <span>RÃ©clamation</span>
            </div>
            <a href="http://localhost:8083/api/v1/reclamation/health" target="_blank" class="btn btn-secondary">:8083</a>
        </div>
    </div>
</div>

<!-- Flow Diagram -->
<div class="card mb-3">
    <div class="card-header">
        <span class="card-title">Flux des Ã©vÃ©nements</span>
    </div>
    <div class="flow-diagram" id="flow-diagram">
        <div class="flow-box" id="flow-quotation">
            <strong>Quotation</strong>
            <div class="text-light">Devis</div>
        </div>
        <span class="flow-arrow">â†’</span>
        <div class="flow-box" id="flow-souscription">
            <strong>Souscription</strong>
            <div class="text-light">Contrats</div>
        </div>
        <span class="flow-arrow">â†’</span>
        <div class="flow-box" id="flow-reclamation">
            <strong>RÃ©clamation</strong>
            <div class="text-light">Sinistres</div>
        </div>
    </div>
</div>

<!-- Recent Events -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Ã‰vÃ©nements rÃ©cents</span>
        <span class="badge badge-info" id="event-count">0 Ã©vÃ©nements</span>
    </div>
    <div class="event-list" id="event-list" hx-ext="sse" sse-connect="/api/sse" sse-swap="message">
        <div class="event-item">
            <div class="event-icon quotation">ğŸ“‹</div>
            <div class="event-content">
                <div class="event-title">En attente d'Ã©vÃ©nements...</div>
                <div class="event-meta">Les Ã©vÃ©nements Kafka apparaÃ®tront ici en temps rÃ©el</div>
            </div>
        </div>
    </div>
</div>

<!-- External Links -->
<h2 class="mb-2">Outils externes</h2>
<div class="external-links">
    <a href="http://localhost:8090" target="_blank" class="external-link">
        ğŸ“Š Kafka UI
    </a>
    <a href="http://localhost:3000" target="_blank" class="external-link">
        ğŸ“ˆ Grafana
    </a>
    <a href="http://localhost:16686" target="_blank" class="external-link">
        ğŸ” Jaeger
    </a>
    <a href="http://localhost:9090" target="_blank" class="external-link">
        ğŸ“‰ Prometheus
    </a>
</div>

<script>
    let eventCount = 0;

    // Ã‰couter les Ã©vÃ©nements SSE
    document.body.addEventListener('htmx:sseMessage', function(event) {
        try {
            const data = JSON.parse(event.detail.data);
            addEvent(data);
        } catch (e) {
            console.error('Erreur parsing SSE:', e);
        }
    });

    function addEvent(event) {
        const eventList = document.getElementById('event-list');
        const eventType = event.type || 'Unknown';

        // DÃ©terminer l'icÃ´ne et la catÃ©gorie
        let icon = 'ğŸ“‹';
        let category = 'quotation';

        if (eventType.includes('Devis')) {
            icon = 'ğŸ“‹';
            category = 'quotation';
        } else if (eventType.includes('Contrat')) {
            icon = 'ğŸ“';
            category = 'souscription';
        } else if (eventType.includes('Sinistre') || eventType.includes('Indemnisation')) {
            icon = 'âš ï¸';
            category = 'reclamation';
        }

        // CrÃ©er l'Ã©lÃ©ment
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item';
        eventItem.innerHTML = `
            <div class="event-icon ${category}">${icon}</div>
            <div class="event-content">
                <div class="event-title">${eventType}</div>
                <div class="event-meta">${JSON.stringify(event.data?.data || event.data || {})}</div>
            </div>
            <span class="event-time">${new Date().toLocaleTimeString()}</span>
        `;

        // InsÃ©rer au dÃ©but
        if (eventList.firstChild) {
            eventList.insertBefore(eventItem, eventList.firstChild);
        } else {
            eventList.appendChild(eventItem);
        }

        // Limiter le nombre d'Ã©vÃ©nements affichÃ©s
        while (eventList.children.length > 50) {
            eventList.removeChild(eventList.lastChild);
        }

        // Mettre Ã  jour le compteur
        eventCount++;
        document.getElementById('event-count').textContent = `${eventCount} Ã©vÃ©nements`;

        // Animer le flow diagram
        animateFlow(category);
    }

    function animateFlow(category) {
        const box = document.getElementById('flow-' + category);
        if (box) {
            box.classList.add('active');
            setTimeout(() => box.classList.remove('active'), 1000);
        }
    }
</script>
{{end}}
