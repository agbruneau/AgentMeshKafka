{{template "base" .}}

{{define "content"}}
<h1>√âv√©nements</h1>

<div class="grid grid-2">
    <!-- Filtres -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Filtres</span>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-primary filter-btn active" data-filter="all">Tous</button>
            <button class="btn btn-secondary filter-btn" data-filter="quotation">Quotation</button>
            <button class="btn btn-secondary filter-btn" data-filter="souscription">Souscription</button>
            <button class="btn btn-secondary filter-btn" data-filter="reclamation">R√©clamation</button>
        </div>
    </div>

    <!-- Statistiques temps r√©el -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Statistiques temps r√©el</span>
        </div>
        <div class="grid grid-4">
            <div class="stat">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-quotation">0</div>
                <div class="stat-label">Quotation</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-souscription">0</div>
                <div class="stat-label">Souscription</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-reclamation">0</div>
                <div class="stat-label">R√©clamation</div>
            </div>
        </div>
    </div>
</div>

<!-- Liste des √©v√©nements -->
<div class="card">
    <div class="card-header">
        <span class="card-title">Flux d'√©v√©nements</span>
        <button class="btn btn-secondary" id="clear-events">Effacer</button>
    </div>
    <div class="event-list" id="event-list" style="max-height: 600px;" hx-ext="sse" sse-connect="/api/sse" sse-swap="message">
        <div class="event-item" id="placeholder">
            <div class="event-icon quotation">‚è≥</div>
            <div class="event-content">
                <div class="event-title">En attente d'√©v√©nements...</div>
                <div class="event-meta">Connect√© au flux SSE. Les √©v√©nements appara√Ætront automatiquement.</div>
            </div>
        </div>
    </div>
</div>

<script>
    let stats = { total: 0, quotation: 0, souscription: 0, reclamation: 0 };
    let currentFilter = 'all';

    // Filtres
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.remove('btn-primary', 'active');
                b.classList.add('btn-secondary');
            });
            this.classList.remove('btn-secondary');
            this.classList.add('btn-primary', 'active');
            currentFilter = this.dataset.filter;
            filterEvents();
        });
    });

    // Effacer
    document.getElementById('clear-events').addEventListener('click', function() {
        const eventList = document.getElementById('event-list');
        eventList.innerHTML = `
            <div class="event-item" id="placeholder">
                <div class="event-icon quotation">‚è≥</div>
                <div class="event-content">
                    <div class="event-title">Liste effac√©e</div>
                    <div class="event-meta">En attente de nouveaux √©v√©nements...</div>
                </div>
            </div>
        `;
        stats = { total: 0, quotation: 0, souscription: 0, reclamation: 0 };
        updateStats();
    });

    // SSE
    document.body.addEventListener('htmx:sseMessage', function(event) {
        try {
            const data = JSON.parse(event.detail.data);
            addEvent(data);
        } catch (e) {
            console.error('Erreur parsing SSE:', e);
        }
    });

    function addEvent(event) {
        // Supprimer le placeholder
        const placeholder = document.getElementById('placeholder');
        if (placeholder) placeholder.remove();

        const eventList = document.getElementById('event-list');
        const eventType = event.type || 'Unknown';

        // D√©terminer la cat√©gorie
        let icon = 'üìã';
        let category = 'quotation';
        let badgeClass = 'badge-info';

        if (eventType.includes('Devis')) {
            icon = eventType.includes('Expire') ? '‚è∞' : 'üìã';
            category = 'quotation';
            badgeClass = eventType.includes('Expire') ? 'badge-warning' : 'badge-info';
        } else if (eventType.includes('Contrat')) {
            if (eventType.includes('Resilie')) {
                icon = '‚ùå';
                badgeClass = 'badge-danger';
            } else if (eventType.includes('Modifie')) {
                icon = '‚úèÔ∏è';
                badgeClass = 'badge-warning';
            } else {
                icon = 'üìù';
                badgeClass = 'badge-success';
            }
            category = 'souscription';
        } else if (eventType.includes('Sinistre') || eventType.includes('Indemnisation')) {
            if (eventType.includes('Indemnisation')) {
                icon = 'üí∞';
                badgeClass = 'badge-success';
            } else if (eventType.includes('Evalue')) {
                icon = 'üîç';
                badgeClass = 'badge-warning';
            } else {
                icon = '‚ö†Ô∏è';
                badgeClass = 'badge-danger';
            }
            category = 'reclamation';
        }

        // Mettre √† jour les stats
        stats.total++;
        stats[category]++;
        updateStats();

        // Cr√©er l'√©l√©ment
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item';
        eventItem.dataset.category = category;
        eventItem.innerHTML = `
            <div class="event-icon ${category}">${icon}</div>
            <div class="event-content">
                <div class="event-title">
                    <span class="badge ${badgeClass}">${eventType}</span>
                </div>
                <div class="event-meta">${formatEventData(event.data?.data || event.data || {})}</div>
            </div>
            <span class="event-time">${new Date().toLocaleTimeString()}</span>
        `;

        // Appliquer le filtre
        if (currentFilter !== 'all' && currentFilter !== category) {
            eventItem.style.display = 'none';
        }

        // Ins√©rer au d√©but
        if (eventList.firstChild) {
            eventList.insertBefore(eventItem, eventList.firstChild);
        } else {
            eventList.appendChild(eventItem);
        }

        // Limiter
        while (eventList.children.length > 100) {
            eventList.removeChild(eventList.lastChild);
        }
    }

    function formatEventData(data) {
        const keys = Object.keys(data).slice(0, 4);
        return keys.map(k => `<strong>${k}:</strong> ${data[k]}`).join(' | ');
    }

    function updateStats() {
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-quotation').textContent = stats.quotation;
        document.getElementById('stat-souscription').textContent = stats.souscription;
        document.getElementById('stat-reclamation').textContent = stats.reclamation;
    }

    function filterEvents() {
        document.querySelectorAll('.event-item').forEach(item => {
            if (item.id === 'placeholder') return;
            if (currentFilter === 'all' || item.dataset.category === currentFilter) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
</script>
{{end}}
